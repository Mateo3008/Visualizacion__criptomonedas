---
title: "An치lisis de Criptomonedas: Visualizaci칩n de Datos"
author: "Rafael Romero, Mateo Barrios"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: cosmo
    highlight: tango
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.align = "center")
```

```{r}
# Cargar librer칤as necesarias
library(httr)
library(jsonlite)
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
library(knitr)
```

```{r}
# Extraer datos de la API
cat("游니 Extrayendo datos de criptomonedas...\n")
datos <- data.frame()

for (i in 0:9) {  # 10 p치ginas para tener suficientes datos
  cat("  P치gina", i+1, "de 10\n")
  
  url <- paste0("https://min-api.cryptocompare.com/data/top/mktcapfull?limit=100&tsym=USD&page=", i)
  respuesta <- GET(url)
  
  if (status_code(respuesta) == 200) {
    json <- fromJSON(content(respuesta, "text", encoding = "UTF-8"))
    
    if (length(json$Data) > 0) {
      temp <- data.frame(
        nombre = json$Data$CoinInfo$FullName,
        simbolo = json$Data$CoinInfo$Name,
        precio = json$Data$RAW$USD$PRICE,
        mcap = json$Data$RAW$USD$MKTCAP,
        volumen = json$Data$RAW$USD$TOTALVOLUME24H,
        cambio = json$Data$RAW$USD$CHANGEPCT24HOUR,
        stringsAsFactors = FALSE
      )
      datos <- bind_rows(datos, temp)
    }
  }
  Sys.sleep(0.3)
}

cat("\n Extracci칩n completada. Total:", nrow(datos), "criptomonedas\n")
```

```{r}
# Limpiar y preparar datos
options(scipen = 999)

datos <- datos %>%
  filter(!is.na(precio), precio > 0, mcap > 0) %>%
  filter(cambio >= quantile(cambio, 0.01, na.rm=TRUE) & 
         cambio <= quantile(cambio, 0.99, na.rm=TRUE))

# Crear categor칤as por precio
datos <- datos %>%
  mutate(
    precio_miles = precio / 1000,
    mcap_milesM = mcap / 1e9,
    volumen_millones = volumen / 1e6,
    categoria = case_when(
      precio < 1 ~ "Micro (<$1)",
      precio < 10 ~ "Peque침a ($1-$10)",
      precio < 100 ~ "Mediana ($10-$100)",
      precio < 1000 ~ "Grande ($100-$1,000)",
      TRUE ~ "Muy grande (>$1,000)"
    )
  )

cat("Datos limpios. Registros finales:", nrow(datos), "\n")
```

```{r}
# Estad칤sticas b치sicas
summary(datos[,c("precio", "mcap_milesM", "volumen_millones", "cambio")])
```

```{r}
ggplot(datos, aes(x = precio)) +
  geom_histogram(bins = 35, fill = "steelblue", alpha = 0.7, color = "white") +
  scale_x_log10(labels = dollar_format()) +
  labs(
    title = "Distribuci칩n de Precios de Criptomonedas",
    subtitle = "Escala logar칤tmica para mejor visualizaci칩n",
    x = "Precio en USD (log)",
    y = "Frecuencia"
  ) +
  theme_minimal()
```

```{r}
top15 <- datos %>%
  arrange(desc(mcap)) %>%
  head(15) %>%
  mutate(nombre = reorder(nombre, mcap))

ggplot(top15, aes(x = mcap_milesM, y = nombre, fill = cambio)) +
  geom_col() +
  scale_fill_gradient2(
    low = "red", mid = "gray90", high = "darkgreen",
    midpoint = 0, name = "Cambio %"
  ) +
  scale_x_continuous(labels = dollar_format(suffix = "B")) +
  labs(
    title = "Top 15 Criptomonedas por Capitalizaci칩n",
    x = "Market Cap (miles de millones USD)",
    y = NULL
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
ggplot(datos, aes(x = precio, y = volumen, color = cambio)) +
  geom_point(alpha = 0.6, size = 1.5) +
  scale_x_log10(labels = dollar_format()) +
  scale_y_log10(labels = dollar_format(scale = 1e-6, suffix = "M")) +
  scale_color_gradient2(
    low = "red", mid = "gray", high = "darkgreen",
    midpoint = 0, name = "Cambio %"
  ) +
  labs(
    title = "Relaci칩n entre Precio y Volumen",
    x = "Precio USD (log)",
    y = "Volumen 24h (millones USD, log)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

